<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Fishery: Trade Module</title>
  <meta name="description" content="Fisheries Trade Documentation">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Fishery: Trade Module" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="img/cover.svg" />
  <meta property="og:description" content="Fisheries Trade Documentation" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Fishery: Trade Module" />
  
  <meta name="twitter:description" content="Fisheries Trade Documentation" />
  <meta name="twitter:image" content="img/cover.svg" />




  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  <link rel="shortcut icon" href="img/logo.png" type="image/x-icon">
<link rel="prev" href="sec-missing.html">
<link rel="next" href="sec-mirroring.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.10/datatables.js"></script>
<link href="libs/dt-core-1.10.19/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.19/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.19/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>



<link rel="stylesheet" href="ess.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#migration-team"><i class="fa fa-check"></i>Migration Team</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="sec-data.html"><a href="sec-data.html"><i class="fa fa-check"></i><b>1</b> Data</a><ul>
<li class="chapter" data-level="1.1" data-path="sec-data.html"><a href="sec-data.html#unsd---comtrade"><i class="fa fa-check"></i><b>1.1</b> UNSD - COMTRADE</a></li>
<li class="chapter" data-level="1.2" data-path="sec-data.html"><a href="sec-data.html#eurostat"><i class="fa fa-check"></i><b>1.2</b> Eurostat</a></li>
<li class="chapter" data-level="1.3" data-path="sec-data.html"><a href="sec-data.html#tdm-and-other-sources"><i class="fa fa-check"></i><b>1.3</b> TDM and other sources</a></li>
<li class="chapter" data-level="1.4" data-path="sec-data.html"><a href="sec-data.html#data-builder"><i class="fa fa-check"></i><b>1.4</b> Data Builder</a><ul>
<li class="chapter" data-level="1.4.1" data-path="sec-data.html"><a href="sec-data.html#functions"><i class="fa fa-check"></i><b>1.4.1</b> Functions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="sec-mapping.html"><a href="sec-mapping.html"><i class="fa fa-check"></i><b>2</b> Mapping trade data</a><ul>
<li class="chapter" data-level="2.1" data-path="sec-mapping.html"><a href="sec-mapping.html#definitions"><i class="fa fa-check"></i><b>2.1</b> Definitions</a></li>
<li class="chapter" data-level="2.2" data-path="sec-mapping.html"><a href="sec-mapping.html#mapping-module"><i class="fa fa-check"></i><b>2.2</b> Mapping Module</a></li>
<li class="chapter" data-level="2.3" data-path="sec-mapping.html"><a href="sec-mapping.html#functions-1"><i class="fa fa-check"></i><b>2.3</b> Functions</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="sec-missing.html"><a href="sec-missing.html"><i class="fa fa-check"></i><b>3</b> Missing data</a><ul>
<li class="chapter" data-level="" data-path="sec-missing.html"><a href="sec-missing.html#data-imputation-summary"><i class="fa fa-check"></i>Data imputation summary</a></li>
<li class="chapter" data-level="" data-path="sec-missing.html"><a href="sec-missing.html#imputation-flow"><i class="fa fa-check"></i>Imputation Flow</a></li>
<li class="chapter" data-level="3.1" data-path="sec-missing.html"><a href="sec-missing.html#mathematical-conversion"><i class="fa fa-check"></i><b>3.1</b> Mathematical conversion</a></li>
<li class="chapter" data-level="3.2" data-path="sec-missing.html"><a href="sec-missing.html#partially-agreggation"><i class="fa fa-check"></i><b>3.2</b> Partially Agreggation</a></li>
<li class="chapter" data-level="3.3" data-path="sec-missing.html"><a href="sec-missing.html#methods"><i class="fa fa-check"></i><b>3.3</b> Methods</a><ul>
<li class="chapter" data-level="3.3.1" data-path="sec-missing.html"><a href="sec-missing.html#sec:helper-tables"><i class="fa fa-check"></i><b>3.3.1</b> Helper Tables</a></li>
<li class="chapter" data-level="3.3.2" data-path="sec-missing.html"><a href="sec-missing.html#sec:weight-unit"><i class="fa fa-check"></i><b>3.3.2</b> Estimate weight per unit</a></li>
<li class="chapter" data-level="3.3.3" data-path="sec-missing.html"><a href="sec-missing.html#sec:estimate-uv"><i class="fa fa-check"></i><b>3.3.3</b> Estimate Unit Value</a></li>
<li class="chapter" data-level="3.3.4" data-path="sec-missing.html"><a href="sec-missing.html#sec:impute-partially-aggregation"><i class="fa fa-check"></i><b>3.3.4</b> Imputation by partially reported weight</a></li>
<li class="chapter" data-level="3.3.5" data-path="sec-missing.html"><a href="sec-missing.html#sec:impute-helper-tables"><i class="fa fa-check"></i><b>3.3.5</b> Imputation using the helper tables</a></li>
<li class="chapter" data-level="3.3.6" data-path="sec-missing.html"><a href="sec-missing.html#interpolate-unit-value"><i class="fa fa-check"></i><b>3.3.6</b> Interpolate Unit Value</a></li>
<li class="chapter" data-level="3.3.7" data-path="sec-missing.html"><a href="sec-missing.html#unit-value-total"><i class="fa fa-check"></i><b>3.3.7</b> Unit Value Total</a></li>
<li class="chapter" data-level="3.3.8" data-path="sec-missing.html"><a href="sec-missing.html#interpolate-unit-value-total"><i class="fa fa-check"></i><b>3.3.8</b> Interpolate Unit Value Total</a></li>
<li class="chapter" data-level="3.3.9" data-path="sec-missing.html"><a href="sec-missing.html#global-year-expanded"><i class="fa fa-check"></i><b>3.3.9</b> Global Year Expanded</a></li>
<li class="chapter" data-level="3.3.10" data-path="sec-missing.html"><a href="sec-missing.html#global-year-expanded---hs6"><i class="fa fa-check"></i><b>3.3.10</b> Global Year Expanded - HS6</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="sec-missing.html"><a href="sec-missing.html#sec:impute-functions"><i class="fa fa-check"></i><b>3.4</b> Functions</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="outlier-detection.html"><a href="outlier-detection.html"><i class="fa fa-check"></i><b>4</b> Outlier Detection</a><ul>
<li class="chapter" data-level="4.1" data-path="outlier-detection.html"><a href="outlier-detection.html#methods-for-outlier-detection"><i class="fa fa-check"></i><b>4.1</b> Methods for outlier detection</a><ul>
<li class="chapter" data-level="4.1.1" data-path="outlier-detection.html"><a href="outlier-detection.html#boxplot-rule"><i class="fa fa-check"></i><b>4.1.1</b> Boxplot rule</a></li>
<li class="chapter" data-level="4.1.2" data-path="outlier-detection.html"><a href="outlier-detection.html#time-series"><i class="fa fa-check"></i><b>4.1.2</b> Time Series</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="outlier-detection.html"><a href="outlier-detection.html#examples"><i class="fa fa-check"></i><b>4.2</b> Examples</a></li>
<li class="chapter" data-level="4.3" data-path="outlier-detection.html"><a href="outlier-detection.html#boxplot"><i class="fa fa-check"></i><b>4.3</b> Boxplot</a><ul>
<li class="chapter" data-level="4.3.1" data-path="outlier-detection.html"><a href="outlier-detection.html#example"><i class="fa fa-check"></i><b>4.3.1</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="outlier-detection.html"><a href="outlier-detection.html#locally-estimated-scatterplot-smoothing-loess"><i class="fa fa-check"></i><b>4.4</b> Locally Estimated Scatterplot Smoothing (LOESS)</a><ul>
<li class="chapter" data-level="4.4.1" data-path="outlier-detection.html"><a href="outlier-detection.html#example-1"><i class="fa fa-check"></i><b>4.4.1</b> Example</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="sec-mirroring.html"><a href="sec-mirroring.html"><i class="fa fa-check"></i><b>5</b> Trade partners</a><ul>
<li class="chapter" data-level="5.1" data-path="sec-mirroring.html"><a href="sec-mirroring.html#scheda"><i class="fa fa-check"></i><b>5.1</b> Scheda</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="appendix-a.html"><a href="appendix-a.html"><i class="fa fa-check"></i><b>A</b> Appendix A</a><ul>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#datatables"><i class="fa fa-check"></i>Datatables</a><ul>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#data-built"><i class="fa fa-check"></i>Data built</a></li>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#trade-mapping-table"><i class="fa fa-check"></i>Trade mapping table</a></li>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#table-to-map-hs-code-to-be-mapped"><i class="fa fa-check"></i>Table to map: HS code to be mapped</a></li>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#hs-masterfile"><i class="fa fa-check"></i>HS masterfile</a></li>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#cn-masterfile"><i class="fa fa-check"></i>CN Masterfile</a></li>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#data-imputed"><i class="fa fa-check"></i>Data imputed</a></li>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#data-imputed-and-validated"><i class="fa fa-check"></i>Data imputed and validated</a></li>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#outliers-detected"><i class="fa fa-check"></i>Outliers detected</a></li>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#outliers-corrected"><i class="fa fa-check"></i>Outliers corrected</a></li>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#outliers-validated"><i class="fa fa-check"></i>Outliers validated</a></li>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#data-mirrored"><i class="fa fa-check"></i>Data mirrored</a></li>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#partnership-mapping-table"><i class="fa fa-check"></i>Partnership mapping table</a></li>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#helper-data-tables"><i class="fa fa-check"></i>Helper data tables</a></li>
<li class="chapter" data-level="" data-path="appendix-a.html"><a href="appendix-a.html#data-sources"><i class="fa fa-check"></i>Data sources</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Fishery: Trade Module</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="outlier-detection" class="section level1">
<h1><span class="header-section-number">4</span> Outlier Detection</h1>
<p>The outlier detection is unlocked to be run only for the countries for which the imputation has been completed. Therefore, the input data is the data table <a href="appendix-a.html#tab:dt-data-imputed-validated"><code>fishtrade_data_imputed_validated</code></a> under domain <strong>Fisheries Commodities</strong>. The main goal of the outlier detection in the Fisheries Module is to figure out discrepancies under the trade data. In the outlier detection process, we should be able to validate the outliers detected, once some values considered as anomaly can be part of the nature of the data. Besides, the methods should be flexible such way the user should be able to run the detection at different levels of aggregation:</p>
<ul>
<li>From the most aggregated one: All reporters / All Flows / All FAO major groups / All partners</li>
<li>To the most detailed one: Reporter / Flow / Tariff line / Partner.</li>
</ul>
<p>No matter the level of aggregation at which the detection is carried out, all modifications or corrections proposal are made at the most detailed level: Reporter | Flow | Tariff line | Partner. When the outlier detection is done at a higher level than the most detailed one (Reporter | Flow | Tariff line | Partner), the user can drill down in order to get to the most general level. When an outlier is identified at an aggregated level, then the tool propagates the correction to lower levels proportionally. Edits are done at the Reporter | Flow | Tariff line | Partner level. The fields that the user can edit are the quantity, the value, the flags and the remarks fields. The unit value and all of the aggregates can be recalculated on the fly after an edit in order to see the implications of the change. In Figure <a href="outlier-detection.html#fig:outlier-flow">4.1</a> is shown the workflow of the outlier detection module.</p>
<ul>
<li><strong>Function:</strong> <a href="https://github.com/SWS-Methodology/faoFisheriesTrade/blob/master/shinyFisheriesTrade_prod/functions/run_outlier_detection_module.R"><code>run_outlier_detection_module</code></a></li>
</ul>
<div class="figure" style="text-align: center"><span id="fig:outlier-flow"></span>
<img src="img/outlier_flow.svg" alt="Outlier Detection Flow." width="100%" />
<p class="caption">
Figure 4.1: Outlier Detection Flow.
</p>
</div>
<div id="methods-for-outlier-detection" class="section level2">
<h2><span class="header-section-number">4.1</span> Methods for outlier detection</h2>
<p>In the Outlier Detection Module is applied two different methods. One that considers the data points as independent across the years, and another that takes account of the time correlation. The idea is to be able to find discrepancies when we compare one figure to the mass of data points, and the second one allows to check if the value is out of the data trend.</p>
<p>The outlier detection methods are applied in the unit value (uv), which is the ratio between the monetary transaction value and its weight, weight, and value variables. In this first step of this procedure, we attempt to figure out outliers in the aggregate level, and then we try to fix the transactions (disaggregated level) that were responsible for generating the outliers detected.</p>
<div id="boxplot-rule" class="section level3">
<h3><span class="header-section-number">4.1.1</span> Boxplot rule</h3>
<p>A boxplot is resource graphic to summarise a distribution of data based on a five numbers summary: “minimum”, first quartile (Q1), median, third quartile (Q3), and “maximum”. It allows us to visualise the outliers and their values. Also, if the data is symmetrical and how tightly your data is grouped. In Figure <a href="outlier-detection.html#fig:boxplot-img">4.2</a> is exemplified the five numbers summary.</p>
<div class="figure" style="text-align: center"><span id="fig:boxplot-img"></span>
<img src="img/boxplot-fig.png" alt="Example of a boxplot. &lt;br&gt; Source: https://towardsdatascience.com/understanding-boxplots-5e2df7bcbd51" width="50%" />
<p class="caption">
Figure 4.2: Example of a boxplot. <br> Source: <a href="https://towardsdatascience.com/understanding-boxplots-5e2df7bcbd51" class="uri">https://towardsdatascience.com/understanding-boxplots-5e2df7bcbd51</a>
</p>
</div>
<p>The steps below aim to apply the boxplot rule in order to figure out discrepant values. Basically, the boxplot rule has an only parameter, <span class="math inline">\(k\)</span>, which is used to compute the upper and lower limits of the boxplot whiskers. In Figure <a href="outlier-detection.html#fig:boxplot-img">4.2</a> the parameter <span class="math inline">\(k\)</span> is set equal <span class="math inline">\(1.5\)</span>, which is the value for the traditional boxplot.</p>
<blockquote>
<ol style="list-style-type: decimal">
<li>Set the coefficient <span class="math inline">\(k\)</span>, for instance <span class="math inline">\(k = 5\)</span>.</li>
<li>Compute the percentiles: 25% (<span class="math inline">\(Q_1\)</span>), and 75% (<span class="math inline">\(Q_3\)</span>).</li>
<li>Compute the interquartile range (IQR): <span class="math inline">\(IQR = Q_3 - Q_1\)</span></li>
<li>Compute <span class="math inline">\(\text{limsup} = Q_3 + k \times IQR\)</span></li>
<li>Compute <span class="math inline">\(\text{liminf} = Q_1 - k \times IQR\)</span></li>
<li>If <span class="math inline">\(x &gt; \text{limsup} \mid x &lt; \text{liminf}\)</span>, then <span class="math inline">\(x\)</span> is a outlier.</li>
</ol>
</blockquote>
<p>Note that there are no assumptions to use the boxplot. Nevertheless, it does not make sense to use the boxplot for small sample size. In this case, we added another parameter in <strong>Outlier Detection Module</strong> to tune the <strong>minimum sample size</strong> to apply this rule. Besides, it is known that the logarithmic function is useful to stable the data distribution, hence the user can choose to apply the logarithmic before to use the boxplot rule, which transforms the method <strong>more conservative</strong>, i.e., <strong>fewer values will be considered as outliers</strong>.</p>
<p>In Figure <a href="outlier-detection.html#fig:outlier-module-parameters">4.3</a> is shown a screenshot of the <strong>Outlier Detection Module</strong>. Note that there is a dialog box to select which source the user wishes to apply the detection of outliers. This option allows the user to choose between the data table <a href="appendix-a.html#tab:dt-data-imputed-validated"><code>fishtrade_data_imputed_validated</code></a> or <a href="appendix-a.html#tab:dt-outliers-corrected"><code>fishtrade_outlier_corrected</code></a>.</p>
<ul>
<li><strong>Function:</strong> <a href="https://github.com/SWS-Methodology/faoFisheriesTrade/blob/master/shinyFisheriesTrade_prod/functions/run_outlier_detection_module.R"><code>od_box_plot</code></a></li>
</ul>
<div class="figure" style="text-align: center"><span id="fig:outlier-module-parameters"></span>
<img src="img/outlier-parameters.png" alt="Outlier Detection Module: list of parameters to be used on this module." width="100%" />
<p class="caption">
Figure 4.3: Outlier Detection Module: list of parameters to be used on this module.
</p>
</div>
<div id="correction" class="section level4 unnumbered">
<h4>Correction</h4>
<p>Once the outlier has been detected, a correction is proposed automatically to be validated by the expert later. The method of correction for outliers detected through the boxplot is made by drawing randomly from a <span class="math inline">\(Uniform(a, b)\)</span> distribution, where the limits of the distributions are:</p>
<blockquote>
<p>Let be <span class="math inline">\(z\)</span> a value detected as a outlier by the boxplot rule.</p>
<ul>
<li>If <span class="math inline">\(z &lt; \text{minimum} \Rightarrow a = \text{minimum}\)</span></li>
<li>If <span class="math inline">\(z &lt; \text{minimum} \Rightarrow b = \text{median}\)</span></li>
<li>If <span class="math inline">\(z &gt; \text{maximum} \Rightarrow a = \text{median}\)</span></li>
<li>If <span class="math inline">\(z &gt; \text{maximum} \Rightarrow b = \text{maximum}\)</span></li>
</ul>
<p>While the value is considered as an outlier, draws from Uniform distribution a correction proposal.</p>
</blockquote>
<p>The idea behind this method is to trust that the outlier detected indeed is discrepant, but it is not too much great or small. Therefore, we select a value randomly from the half of the data distribution in order to “correct” this value. In Figure <a href="outlier-detection.html#fig:boxplot-correction">4.4</a>, we show a illustration of the boxplot correction.</p>
<div class="figure" style="text-align: center"><span id="fig:boxplot-correction"></span>
<img src="img/correction-boxplot.svg" alt="Illustration of the boxplot correction.." width="70%" />
<p class="caption">
Figure 4.4: Illustration of the boxplot correction..
</p>
</div>
</div>
</div>
<div id="time-series" class="section level3">
<h3><span class="header-section-number">4.1.2</span> Time Series</h3>
<p>The Time Series method is applied only for those aggregations with more than <span class="math inline">\(s\)</span> sequenctial years available. This parameter <span class="math inline">\(s\)</span> is shown in Figure <a href="outlier-detection.html#fig:outlier-module-parameters">4.3</a> as “Sequential length”. Another parameter is the logarithmic, the user can choose if it will be applied the logarithmic over the target variable or not.</p>
<p>The outliers are identified by fitting a <a href="https://en.wikipedia.org/wiki/Local_regression">loess curve</a> for non-seasonal data and via a periodic STL decomposition for seasonal data. If the residuals, difference between fitted and observed values, lie outside the range <span class="math inline">\(\pm{2}(q_{0.9}-q_{0.1})\)</span> where <span class="math inline">\(q_p\)</span> is the <span class="math inline">\(p-\)</span>quantile of the residuals, then they will be considered as outliers. For a Gaussian distribution, it will identify less than <span class="math inline">\(1\)</span> point in <span class="math inline">\(3\)</span> million as an outlier.</p>
<p>In Figure <a href="outlier-detection.html#fig:ts-fitted">4.5</a>, we show an example of time series and its respectively loess curve fitted. Note that, the loess curve follows the data trend. In this example, it is easy to identify the outlier candidate. The next step is to compute the difference between the curves to get the residuals.</p>
<div class="figure" style="text-align: center"><span id="fig:ts-fitted"></span>
<img src="bookdown-FisheriesTrade_files/figure-html/ts-fitted-1.svg" alt="Time series of the data observed and the loess curve fitted." width="672" />
<p class="caption">
Figure 4.5: Time series of the data observed and the loess curve fitted.
</p>
</div>
<p>In Figure <a href="outlier-detection.html#fig:ts-resid">4.6</a>, we show the histogram of the residuals as well as the limits used to identify the outliers. Note that, there is only one value that lies outside of the interval, hence this value is considered as outlier. The limits are defined as following:</p>
<ol style="list-style-type: decimal">
<li>Compute the quantiles <span class="math inline">\(q_{0.25}\)</span>, and <span class="math inline">\(q_{0.75}\)</span>.</li>
<li>Compute the interquartile range : <span class="math inline">\(IQR = q_{0.75} - q_{0.25}\)</span></li>
<li>Limits:
<ul>
<li><span class="math inline">\(\text{liminf} = q_{0.25} - 3 \times IQR\)</span></li>
<li><span class="math inline">\(\text{limsup} = q_{0.75} + 3 \times IQR\)</span></li>
</ul></li>
</ol>
<div class="figure" style="text-align: center"><span id="fig:ts-resid"></span>
<img src="bookdown-FisheriesTrade_files/figure-html/ts-resid-1.svg" alt="Histogram of the residuals and their respectively limits." width="672" />
<p class="caption">
Figure 4.6: Histogram of the residuals and their respectively limits.
</p>
</div>
<div id="correction-1" class="section level4 unnumbered">
<h4>Correction</h4>
<p>In the Time Series method, the correction is performed by replacing the values detected as outliers by fitted values. In Figure <a href="outlier-detection.html#fig:ts-correction">4.7</a>, we show how the correction is performed over the time series method.</p>
<ul>
<li><strong>Function:</strong> <a href="https://github.com/SWS-Methodology/faoFisheriesTrade/blob/master/shinyFisheriesTrade_prod/functions/run_outlier_detection_module.R"><code>od_ts_toolbox</code></a></li>
</ul>
<div class="figure" style="text-align: center"><span id="fig:ts-correction"></span>
<img src="bookdown-FisheriesTrade_files/figure-html/ts-correction-1.svg" alt="Fitted values used as correction proposal." width="672" />
<p class="caption">
Figure 4.7: Fitted values used as correction proposal.
</p>
</div>
</div>
</div>
</div>
<div id="examples" class="section level2">
<h2><span class="header-section-number">4.2</span> Examples</h2>
<p>The outlier detection methods are applied in the unit value (uv) variable, which is the ratio between the monetary transaction value and its weight. In this first step of this procedure, we attempt to figure out outliers in the aggregate level, and then we try to fix the transactions (disaggregated level) that were responsible for generating the outliers detected.</p>
<p>The aggregated level means to compute the unit value by reporter, flow, and FAO code, i.e., for each combination of reporter, flow, and FAO code we calculate the ratio between the summing of the monetary value and the summing of the weight. For instance, in Table 1 is shown a subset from the full data using the following parameters:</p>
<ul>
<li><code>reporter</code>: 76</li>
<li><code>year</code>: 2005</li>
<li><code>flow</code>: 1</li>
<li><code>faocode</code>: 292.9.1.90</li>
</ul>
<div id="htmlwidget-dee79e22c86dedc54252" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-dee79e22c86dedc54252">{"x":{"filter":"none","caption":"<caption>Table 1: Imports of the commodity (FAOCODE) 292.9.1.90 for the year 2005, and reporter 76 (Brazil).<\/caption>","data":[[76,76,76,76,76,76,76,76,76,76,76,76],[1,1,1,1,1,1,1,1,1,1,1,1],[2005,2005,2005,2005,2005,2005,2005,2005,2005,2005,2005,2005],["292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90"],[152,158,250,276,352,360,372,392,410,608,840,1248],[65438,1910,25862,19187,9160,1115712,4386,58248,71675,39387,44329,438234],[73173,613,11097,2250,7565,1505700,1000,13282,19883,71300.4324035991,5949,93719],[0.894291610293414,3.11582381729201,2.33053978552762,8.52755555555555,1.21083939193655,0.740992229527794,4.386,4.38548411383828,3.60483830407886,0.552408992094862,7.45150445453017,4.6760422112912]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>reporter<\/th>\n      <th>flow<\/th>\n      <th>year<\/th>\n      <th>faocode<\/th>\n      <th>partner<\/th>\n      <th>value<\/th>\n      <th>weight<\/th>\n      <th>uv<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","columnDefs":[{"className":"dt-right","targets":[0,1,2,4,5,6,7]}],"order":[],"autoWidth":false,"orderClasses":false,"rowCallback":"function(row, data) {\nDTWidget.formatCurrency(this, row, data, 5, \"$\", 0, 3, \",\", \".\", true);\nDTWidget.formatRound(this, row, data, 6, 2, 3, \",\", \".\");\nDTWidget.formatRound(this, row, data, 7, 2, 3, \",\", \".\");\n}"}},"evals":["options.rowCallback"],"jsHooks":[]}</script>
<p>To calculate the unit value in the aggregate level, it is needed to apply the equation below:</p>
<p><span class="math display">\[uv = \frac{\sum_{p = 1}^{P} value_p}{\sum_{p = 1}^{P} weight_p}\]</span>
where <span class="math inline">\(value_p\)</span> is the monetary value from the p-th partner, as well as <span class="math inline">\(weight_p\)</span> is the transaction weight, <span class="math inline">\(P\)</span> is the total of partners in this given combination, in this small example <span class="math inline">\(P = 12\)</span>. In order to make this report comprehensible, we show the <code>uv</code> calculation step-by-step as following:</p>
<p><span class="math display">\[\begin{align}
uv  &amp; = \frac{65438+1910 + \cdots + 44329+438234}{73173+613 + \cdots + 5949+93719} \\ \\
&amp; = \frac{1,893,528}{1,805,531} \\ \\
&amp; = 1.05
\end{align}\]</span></p>
<p>If we repeat it procedure for all available year for this combination, we will find the values shown in Table 2. The highlighted row shows the <code>uv</code> computed previously, as shown in the equations sequence.</p>
<div id="htmlwidget-0f0b0ea0f6d35036bb7f" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-0f0b0ea0f6d35036bb7f">{"x":{"filter":"none","caption":"<caption>Table 2: Data aggregation by reporter, flow, and year.<\/caption>","data":[[76,76,76,76,76,76,76,76,76,76,76,76,76],[1,1,1,1,1,1,1,1,1,1,1,1,1],[2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012],["292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90","292.9.1.90"],[2061265,1165355,1467727,1835708,1948360,1893528,2119873,2335584,3375543,3807503,4541085,7303096,32890],[1692078,809005,1224772.63025677,1652935.19460362,1735583.36061187,1805531.4324036,1816387.09460859,1966138.34623177,2086388.07259209,2129944.07628759,2172187,3076390.53723858,2820],[1.21818556827759,1.44047935426852,1.19836691622697,1.11057469524098,1.12259661173124,1.04873721166917,1.1670821744397,1.1879042003714,1.61788837098091,1.78760702799124,2.09055896200465,2.37391706663985,11.6631205673759]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>reporter<\/th>\n      <th>flow<\/th>\n      <th>year<\/th>\n      <th>faocode<\/th>\n      <th>value<\/th>\n      <th>weight<\/th>\n      <th>uv<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","pageLength":13,"columnDefs":[{"className":"dt-right","targets":[0,1,2,4,5,6]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,13,25,50,100],"rowCallback":"function(row, data) {\nDTWidget.formatCurrency(this, row, data, 4, \"$\", 0, 3, \",\", \".\", true);\nDTWidget.formatRound(this, row, data, 5, 2, 3, \",\", \".\");\nDTWidget.formatRound(this, row, data, 6, 2, 3, \",\", \".\");\nvar value=data[2]; $(row).css({'color':value == 2005 ? \"#DDDDDD\" : value,'background-color':value == 2005 ? \"#3B556E\" : value});\n}"}},"evals":["options.rowCallback"],"jsHooks":[]}</script>
<p>In Figure 1 is shown the same information stored in Table 1, i.e., the unit value computed in the aggregated level by year. The outlier can be easily identified when we look to the graphic below. The <code>uv</code> seems to be a stable behavior from 2000 to 2011 when you analyze Figure 1. However, in 2012 a sharp increase in the <code>uv</code> is noted. On the other hand, when we look at Figure 2, that is the same information, but without the year 2012, so it is possible to see clearly the increasing trend starting in 2007.</p>
<div class="row">
<div class="col-md-6">
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-2"></span>
<img src="bookdown-FisheriesTrade_files/figure-html/unnamed-chunk-2-1.svg" alt="Figure 1: The whole time series of imports." width="672" />
<p class="caption">
Figure 4.8: Figure 1: The whole time series of imports.
</p>
</div>
</div>
<div class="col-md-6">
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-3"></span>
<img src="bookdown-FisheriesTrade_files/figure-html/unnamed-chunk-3-1.svg" alt="Figure 2: The time series of imports without the year 2012." width="672" />
<p class="caption">
Figure 4.9: Figure 2: The time series of imports without the year 2012.
</p>
</div>
</div>
</div>
<p>Despite the visual approach works well to identify the possible outliers, it is not possible to check each graphic to figure out the outliers. Therefore, it needs to use a general rule that can be applied in each combination. In the next section, we show two methods to figure out outliers in the trade data, the first one is the Boxplot, and the second one is the Median Absolute Deviation (MAD).</p>
</div>
<div id="boxplot" class="section level2">
<h2><span class="header-section-number">4.3</span> Boxplot</h2>
<p>One of the methods to try figured out outlier in the aggregated data is the boxplot rule.</p>
<ol style="list-style-type: decimal">
<li>Set the coefficient <span class="math inline">\(k\)</span>, for instance <span class="math inline">\(k = 5\)</span>.</li>
<li>Compute the percentiles: 25% (<span class="math inline">\(Q_1\)</span>), and 75% (<span class="math inline">\(Q_3\)</span>).</li>
<li>Compute the interquartile range (IQR): <span class="math inline">\(IQR = Q_3 - Q_1\)</span></li>
<li>Compute <span class="math inline">\(\text{limsup} = Q_3 + k \times IQR\)</span></li>
<li>Compute <span class="math inline">\(\text{liminf} = Q_1 - k \times IQR\)</span></li>
<li>If <span class="math inline">\(uv &gt; \text{limsup} \mid uv &lt; \text{liminf}\)</span>, then <span class="math inline">\(uv\)</span> is a outlier.</li>
</ol>
<div class="rmdnote">
<p>
The IQR is a measure of variability, based on dividing a data set into quartiles. Quartiles divide a rank-ordered data set into four equal parts. The values that separate parts are called the first, second, and third quartiles; and they are denoted by Q1, Q2, and Q3, respectively.
</p>
</div>
<div id="example" class="section level3">
<h3><span class="header-section-number">4.3.1</span> Example</h3>
<ol style="list-style-type: decimal">
<li><span class="math inline">\(k = 5\)</span></li>
<li>Compute the percentiles:
<ul>
<li><span class="math inline">\(Q_1 = 1.167\)</span></li>
<li><span class="math inline">\(Q_3 = 1.788\)</span></li>
</ul></li>
<li><span class="math inline">\(IQR = Q_3 - Q_1 = 0.621\)</span></li>
<li><span class="math inline">\(\text{limsup} = 4.893\)</span></li>
<li><span class="math inline">\(\text{liminf} = -1.938\)</span></li>
</ol>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-5"></span>
<img src="bookdown-FisheriesTrade_files/figure-html/unnamed-chunk-5-1.svg" alt="Figure 3: Boxplot exemplifying the outlier detection." width="576" />
<p class="caption">
Figure 4.10: Figure 3: Boxplot exemplifying the outlier detection.
</p>
</div>
<!-- ## Median Absolute Deviation (MAD) -->
<!-- There are many methods for outlier detection, for instance, model-based, quantiles methods, and deviation from average. However, in this task, we are manipulating the massive amount of heterogeneous data grouped in country and commodity class. Therefore, a general and straightforward method can be an excellent choice to perform outlier detection. Given this scenario, the Median Absolute Deviation (MAD) was adopted and applied for each commodity per year. The main idea of this strategy is to find outliers that are away from its median when compared in the same commodity. -->
<!-- $$ -->
<!-- z = \frac{|uv_i - median(uv_i)|}{MAD} \\ -->
<!-- MAD = median(|uv_i - median(uv_i)|) -->
<!-- $$ -->
<!-- The steps are as follow: -->
<!-- 1. Compute $z$ as shown in the equation above. -->
<!-- 2. Compute $\text{limsup} = median(z) + k \times 1.4826 \times MAD$ -->
<!-- 4. Compute $\text{liminf} = median(z) - k \times 1.4826 \times MAD$ -->
<!-- 5. If $z > \text{limsup} \mid z < \text{liminf}$, then $uv$ is a outlier. -->
<!-- ### Example -->
<!-- 1. Compute $z$ as shown in the equation above. -->
<!-- 2. Compute $\text{limsup} = 1.22  + 5 \times 1.4826 \times 0.25 = 3.07$ -->
<!-- 4. Compute $\text{liminf} = 1.22  - 5 \times 1.4826 \times 0.25 = -0.63$ -->
<!-- 5. If $z > \text{limsup} \mid z < \text{liminf}$, then $uv$ is a outlier. -->
<!-- ```{r , echo = FALSE, fig.align='center', fig.width=9, fig.height=9/1.618,fig.cap="Figure 4: Outliers detected by the MAD method..", dev = c('svg')} -->
<!-- gg_data$z <- abs(gg_data$uv - median(gg_data$uv))/mad(gg_data$uv) -->
<!-- ggplot(data = gg_data, aes(x = year, y = uv)) + -->
<!--   geom_line(size = 1.5, color = "#3B556E") + -->
<!--   geom_point(size = 3, aes(color = out_mad)) + -->
<!--   ggrepel::geom_label_repel(aes(label = round(z, 1))) + -->
<!--   scale_color_manual(values = c("#3B556E", "tomato")) + -->
<!--   scale_x_continuous(breaks = gg_data$year) + -->
<!--   labs(title = "",  -->
<!--        subtitle = "",  -->
<!--        color = "Outlier", -->
<!--        y = 'Unit Value', x = 'Year') + -->
<!--   theme_minimal() + -->
<!--   theme(axis.text = element_text(size = 12),  -->
<!--         axis.title = element_text(size = 14),  -->
<!--         panel.grid = element_line(color = '#cccccc'), -->
<!--         plot.background = element_rect(fill = "#eeeeeeff", colour = "#eeeeeeff")) -->
<!-- ``` -->
<!-- ## Correction of main outlier -->
<!-- Once the outlier is detected at the aggregated level, the following step is to figure out the transaction values that were responsible for contributing to the outlier. In this project, we use two approaches for attempting to fix the discrepant values detected in the previous step. The first one is a model-based, and the second one is based on the median weighted average.  -->
<!-- The choice of approach is based on the number of transactions available on the disaggregated level. If the number of transaction is less than $5$, then we choose the model-based approach, otherwise the median weighted average is chosen. For instance, in the previous step, the year 2012 was detected as an outlier by the two approaches. When this year is disgregated, there is only one ($n = 1$) transaction that could be responsible for generating this outlier. In this case, the approach chosen is the model-based, once $n = 1$. -->
<!-- ```{r , echo = FALSE, fig.cap="", dev=c('svg')} -->
<!-- tldata[year == 2012 &  -->
<!--                  reporter == p_reporter &  -->
<!--                  flow == p_flow &  -->
<!--                  faocode == p_faocode,  -->
<!--        .(reporter, flow, year, faocode, partner, value, weight, uv)] %>% -->
<!--     select(reporter, flow, year, faocode, value, weight, uv) %>% -->
<!--   datatable(options = list(dom = 't',  -->
<!--                            pageLength = nrow(gg_data)), -->
<!--             rownames = FALSE,  -->
<!--             caption = "") %>% -->
<!--   formatCurrency("value", digits = 0) %>% -->
<!--   formatRound(c("weight", "uv"), 2) %>% -->
<!--   formatStyle("year",  -->
<!--               target = 'row',  -->
<!--               color = styleEqual(p_year, '#DDDDDD'), -->
<!--               backgroundColor = styleEqual(p_year, '#3B556E')) -->
<!-- ``` -->
</div>
</div>
<div id="locally-estimated-scatterplot-smoothing-loess" class="section level2">
<h2><span class="header-section-number">4.4</span> Locally Estimated Scatterplot Smoothing (LOESS)</h2>
<p>To fix the transactions that generated the outlier in the aggregated level is fitted a LOESS model considering the <code>log(uv)</code> as variable response and <code>year</code> as the covariate. The rows which the year was detected as outlier were removed before to fit the model. Once the model is fitted, it is used to predict a new value to the given year. In our example, the year is 2012 and the value predicted by model is 4.701.</p>
<div id="example-1" class="section level3">
<h3><span class="header-section-number">4.4.1</span> Example</h3>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-7"></span>
<img src="bookdown-FisheriesTrade_files/figure-html/unnamed-chunk-7-1.svg" alt="Figure 4: Correction of the outlier using the LOESS model." width="864" />
<p class="caption">
Figure 4.11: Figure 4: Correction of the outlier using the LOESS model.
</p>
</div>
<!-- ### Median weighted average -->
<!-- When the number of transactions in the disaggregated level is greater than or equal $5$, i.e., $n \geq 5$, the method Median weighted is chosen. In this case, before to apply the correction method we should to identify those/that transactions responsible for generating the outlier. Therefore, the methods to detect outlier mentioned previously are applied in the disaggregated level and then it is possible to identify that/those discrepant transactions. -->
<!-- Once the discrepant transactions are identified the correction is value is computed as following: -->
<!-- 1. The historical median for `uv` for each partner is calculated - $M_{hist}$. -->
<!-- 2. The median for `uv` for the given year is calculated - $M_{partner}$ -->
<!-- 3. The new `uv` is $uv_{new} = \frac{M_{hist} + M_{partner}}{2}$ -->

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="sec-missing.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="sec-mirroring.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
